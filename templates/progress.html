<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Progress Tracker üìä</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.css">
    <style>
        body {
            background: linear-gradient(to right, #fbc2eb, #a6c1ee);
            font-family: 'Segoe UI', sans-serif;
            padding: 2rem;
            color: #333;
        }
        .container {
            max-width: 1200px;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 0 12px rgba(0,0,0,0.2);
            padding: 2rem;
            margin-bottom: 2rem;
        }
        .stats-card {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }
        .stats-card:hover {
            transform: translateY(-5px);
        }
        .progress-chart {
            background: white;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }
        .leaderboard-table {
            background: white;
            border-radius: 8px;
            overflow: hidden;
        }
        .leaderboard-table th {
            background: #4a90e2;
            color: white;
        }
        .user-rank {
            font-size: 1.2rem;
            font-weight: bold;
            color: #4a90e2;
        }
        .badge-difficulty {
            padding: 0.3rem 0.6rem;
            border-radius: 12px;
            font-size: 0.8rem;
        }
        .badge-easy { background-color: #28a745; color: white; }
        .badge-medium { background-color: #ffc107; color: black; }
        .badge-hard { background-color: #dc3545; color: white; }
        
        .chart-loading, .chart-error {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: rgba(255, 255, 255, 0.9);
        }

        .chart-error {
            padding: 1rem;
        }

        .chart-error .alert {
            max-width: 300px;
            margin: 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>Progress Tracker üìä</h1>
            <div>
                <a href="{{ url_for('pages.dashboard') }}" class="btn btn-outline-primary">Dashboard</a>
                <a href="{{ url_for('pages.quiz') }}" class="btn btn-primary ms-2">Take Quiz</a>
            </div>
        </div>

        <!-- Stats Overview -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="stats-card text-center" data-value="{{ stats.total_attempts|default(0) }}">
                    <h3 class="display-4 counter">0</h3>
                    <p class="text-muted mb-0">Total Attempts</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card text-center" data-value="{{ stats.success_rate|default(0) }}">
                    <h3 class="display-4"><span class="counter">0</span>%</h3>
                    <p class="text-muted mb-0">Success Rate</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card text-center" data-value="{{ stats.completed_questions|default(0) }}">
                    <h3 class="display-4 counter">0</h3>
                    <p class="text-muted mb-0">Questions Completed</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card text-center" data-value="{{ stats.current_streak|default(0) }}">
                    <h3 class="display-4 counter">0</h3>
                    <p class="text-muted mb-0">Current Streak</p>
                    {% if stats.current_streak >= 3 %}
                        <span class="badge bg-warning mt-2">üî• Hot Streak!</span>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Progress Chart -->
        <div class="row mb-4">
            <div class="col-md-8">
                <div class="progress-chart">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h4>Progress Over Time</h4>
                        <div class="chart-legend">
                            <span class="badge bg-primary">Daily Progress</span>
                        </div>
                    </div>
                    <div class="chart-container" style="position: relative; height: 300px;">
                        <canvas id="progressChart"></canvas>
                        <div id="progressChartError" class="chart-error d-none">
                            <div class="alert alert-warning">
                                No progress data available yet. Complete some quizzes to see your progress!
                            </div>
                        </div>
                        <div id="progressChartLoading" class="chart-loading">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="progress-chart">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h4>Difficulty Distribution</h4>
                    </div>
                    <div class="chart-container" style="position: relative; height: 300px;">
                        <canvas id="difficultyChart"></canvas>
                        <div id="difficultyChartError" class="chart-error d-none">
                            <div class="alert alert-warning">
                                No difficulty data available yet.
                            </div>
                        </div>
                        <div id="difficultyChartLoading" class="chart-loading">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Leaderboard -->
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0">üèÜ Leaderboard</h4>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Rank</th>
                                <th>User</th>
                                <th>Score</th>
                                <th>Questions Solved</th>
                                <th>Success Rate</th>
                                <th>Last Active</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for user in leaderboard %}
                            <tr {% if user.rollno == session.rollno %}class="table-primary"{% endif %}>
                                <td class="user-rank">#{{ loop.index }}</td>
                                <td>{{ user.rollno }}</td>
                                <td>{{ user.total_score }}</td>
                                <td>{{ user.questions_solved }}</td>
                                <td>{{ user.success_rate }}%</td>
                                <td>{{ user.last_active.strftime('%Y-%m-%d %H:%M') }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/CountUp.js/2.0.7/countUp.min.js"></script>
    <script>
        function initializeCounters() {
            document.querySelectorAll('.stats-card').forEach(card => {
                const counterEl = card.querySelector('.counter');
                if (!counterEl) return;
                
                const targetValue = parseFloat(card.dataset.value) || 0;
                
                if (typeof CountUp === 'undefined') {
                    // Fallback if CountUp hasn't loaded
                    counterEl.textContent = targetValue;
                    return;
                }
                
                const counter = new CountUp(counterEl, targetValue, {
                    duration: 2,
                    separator: ',',
                    decimal: '.',
                    decimalPlaces: targetValue % 1 === 0 ? 0 : 1
                });
                
                if (!counter.error) {
                    counter.start();
                } else {
                    // Fallback if counter fails
                    counterEl.textContent = targetValue;
                }
            });
        }

        function initializeCharts() {
            // Get chart data from template variables
            const chartData = {
                dates: JSON.parse('{{ dates|tojson|safe }}' || '[]'),
                progress: JSON.parse('{{ progress_data|tojson|safe }}' || '[]'),
                difficulty: {
                    easy: Number('{{ stats.difficulty_distribution.easy|default(0) }}'),
                    medium: Number('{{ stats.difficulty_distribution.medium|default(0) }}'),
                    hard: Number('{{ stats.difficulty_distribution.hard|default(0) }}')
                }
            };

            createProgressChart(chartData);
            createDifficultyChart(chartData);
        }

        function createProgressChart(data) {
            const progressCtx = document.getElementById('progressChart');
            if (!progressCtx) {
                console.error('Progress chart context not found');
                return;
            }

            // Destroy existing chart if it exists
            if (progressCtx.chart) {
                progressCtx.chart.destroy();
            }

            if (!data.dates.length || !data.progress.length) {
                document.getElementById('progressChartError').classList.remove('d-none');
                document.getElementById('progressChartLoading').classList.add('d-none');
                return;
            }

            // Format dates to be more readable
            const formattedDates = data.dates.map(date => {
                try {
                    return new Date(date).toLocaleDateString();
                } catch (e) {
                    return date;
                }
            });

            // Create gradient fill
            const gradient = progressCtx.getContext('2d').createLinearGradient(0, 0, 0, 400);
            gradient.addColorStop(0, 'rgba(74, 144, 226, 0.3)');
            gradient.addColorStop(1, 'rgba(74, 144, 226, 0.0)');

            progressCtx.chart = new Chart(progressCtx, {
                type: 'line',
                data: {
                    labels: formattedDates,
                    datasets: [{
                        label: 'Questions Solved',
                        data: data.progress,
                        borderColor: '#4a90e2',
                        backgroundColor: gradient,
                        tension: 0.3,
                        fill: true,
                        pointBackgroundColor: '#ffffff',
                        pointBorderColor: '#4a90e2',
                        pointBorderWidth: 2,
                        pointRadius: 4,
                        pointHoverRadius: 6,
                        pointHoverBorderWidth: 3,
                        pointHoverBackgroundColor: '#4a90e2'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 12,
                            titleFont: {
                                size: 14,
                                weight: 'bold'
                            },
                            bodyFont: {
                                size: 13
                            },
                            callbacks: {
                                title: function(context) {
                                    return context[0].label;
                                },
                                label: function(context) {
                                    return `Questions Solved: ${context.raw}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Questions Solved'
                            },
                            ticks: {
                                stepSize: 1,
                                precision: 0
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Date'
                            },
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45
                            }
                        }
                    }
                }
            });

            document.getElementById('progressChartLoading').classList.add('d-none');
        }

        function createDifficultyChart(data) {
            const difficultyCtx = document.getElementById('difficultyChart');
            if (!difficultyCtx) {
                console.error('Difficulty chart context not found');
                return;
            }

            // Destroy existing chart if it exists
            if (difficultyCtx.chart) {
                difficultyCtx.chart.destroy();
            }

            const totalQuestions = data.difficulty.easy + data.difficulty.medium + data.difficulty.hard;
            
            if (totalQuestions === 0) {
                document.getElementById('difficultyChartError').classList.remove('d-none');
                document.getElementById('difficultyChartLoading').classList.add('d-none');
                return;
            }

            difficultyCtx.chart = new Chart(difficultyCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Easy', 'Medium', 'Hard'],
                    datasets: [{
                        data: [
                            data.difficulty.easy,
                            data.difficulty.medium,
                            data.difficulty.hard
                        ],
                        backgroundColor: [
                            '#28a745',  // Easy - Green
                            '#ffc107',  // Medium - Yellow
                            '#dc3545'   // Hard - Red
                        ],
                        borderWidth: 0,
                        hoverOffset: 15
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '70%',
                    layout: {
                        padding: 20
                    },
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                generateLabels: function(chart) {
                                    const data = chart.data;
                                    if (data.labels.length && data.datasets.length) {
                                        return data.labels.map((label, i) => {
                                            const value = data.datasets[0].data[i];
                                            const percentage = ((value / totalQuestions) * 100).toFixed(1);
                                            return {
                                                text: `${label} (${value} - ${percentage}%)`,
                                                fillStyle: data.datasets[0].backgroundColor[i],
                                                hidden: isNaN(data.datasets[0].data[i]) || data.datasets[0].data[i] === 0,
                                                index: i
                                            };
                                        });
                                    }
                                    return [];
                                }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 12,
                            titleFont: {
                                size: 14,
                                weight: 'bold'
                            },
                            bodyFont: {
                                size: 13
                            },
                            callbacks: {
                                label: function(context) {
                                    const value = context.raw;
                                    const percentage = ((value / totalQuestions) * 100).toFixed(1);
                                    return `${context.label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    },
                    animation: {
                        animateScale: true,
                        animateRotate: true,
                        duration: 2000,
                        easing: 'easeInOutQuart'
                    }
                }
            });

            document.getElementById('difficultyChartLoading').classList.add('d-none');
        }

        window.addEventListener('load', function() {
            initializeCounters();
            initializeCharts();
        });
    </script>
</body>
</html>